
<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <!--[if lte IE 8]>
      <script type="text/javascript">
        var tags = ['header', 'footer', 'nav', 'aside', 'article', 'section', 'object', 'main'];
        for (var i in tags) {
          document.createElement(tags[i]);
        }
      </script>
    <![endif]-->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>移动端浏览器对audio标签的限制总结</title>
    <!-- font -->
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" />
    <!-- js -->
    <script type="text/javascript" src="/js/jquery-3.3.1.min.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="/css/reset.css" />
    <link rel="stylesheet" href="/css/icon.css" />
    <link rel="stylesheet" href="/katex/katex.min.css" />
     
    <link rel="stylesheet" href="/css/index.css" />
     
  <meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <!-- header -->
    <header class="header">
  <div class="logo">
    <!-- logo -->
    <div class="logo-wrap">
      <a href="/" id="logo"></a>
    </div>
  </div>
  <nav class="nav" id="top-nav">
    <ul>
      
        <li>
          <a class="" href="/">主页</a>
        </li>
      
        <li>
          <a class="" href="/categories">分类</a>
        </li>
      
        <li>
          <a class="" href="/tags">标签</a>
        </li>
      
        <li>
          <a class="" href="/archives">归档</a>
        </li>
      
      <!-- search -->
      
    </ul>
  </nav>
</header>


  
    <!-- main -->
    <main id="main" class="main">
      <!-- post -->

<div class="post show-toc">
  <!-- table of content -->
  
    <div class="post-toc">
      <div class="post-toc-content">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-text"> 测试环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E6%94%AF%E6%8C%81autoplaypreload"><span class="toc-text"> 不支持autoplay&#x2F;preload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AA%E6%9C%89%E7%94%A8%E6%88%B7%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91%E7%9A%84%E4%BA%8B%E4%BB%B6%E8%83%BD%E8%B0%83%E7%94%A8playload"><span class="toc-text"> 只有用户手动触发的事件能调用play&#x2F;load</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E9%99%90%E5%88%B6"><span class="toc-text"> 时间限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E8%A7%A6%E5%8F%91"><span class="toc-text"> 再次触发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#src%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD"><span class="toc-text"> src延迟加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%99%90%E5%88%B6"><span class="toc-text"> 其他限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8vue%E4%B8%AD%E4%BD%BF%E7%94%A8audio%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="toc-text"> 在Vue中使用audio的示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text"> 参考</span></a></li></ol>
      </div>
    </div>
  
  <!-- table of content end-->
  <!-- article -->
  <div class="cell">
    <article class="article">
      <!-- title -->
      
          <h1  class="title">移动端浏览器对audio标签的限制总结</h1> 
      
      <div class="post-meta">
        <!-- time -->
        
          <span class="icon-baseline-query_builder-24px"></span>
          <time datetime="2019-03-03T09:00:00.000Z">
            2019-03-03
          </time>
        
        <!-- categories -->
        <!--
          <span class="icon-baseline-work_outline-24px"></span>
          
            <a href="/categories/Vue/">
              <span>Vue</span>
            </a>
          
        -->
        <!-- categories end -->
        <!-- tag -->
        <span class="icon-baseline-subtitles-24px"></span>
        
          <a href="/tags/JavaScript/">
            <span>JavaScript</span>
          </a>
        
          <a href="/tags/Vue/">
            <span>Vue</span>
          </a>
        
      </div>
      <!-- content -->
      <div class="article-content">
      <p>往往在桌面写好的播放功能,到移动端各种出错.<br />
这是因为在移动端,对于audio的使用有很多限制,特别是safari.<br />
而且现在的各种框架, 极大加深了程序的复杂程度,使调试变得异常困难.</p>
<h2 id="测试环境"><a class="markdownIt-Anchor" href="#测试环境"></a> 测试环境</h2>
<p>本文测试环境为iPad ios12,没有条件进行iphone/桌面端safari环境下audio的表现</p>
<h2 id="不支持autoplaypreload"><a class="markdownIt-Anchor" href="#不支持autoplaypreload"></a> 不支持autoplay/preload</h2>
<p>大部分移动端浏览器都不允许网页自动播放/预加载音乐.<br />
例如下面这个示例, 桌面浏览器可以自动播放,而移动浏览器没有任何反应.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span> <span class="attr">autoplay</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>除非用户点了播放按钮/手动触发了某个事件(这个事件里调用了audio.play()方法)<br />
为啥这么设计?据说是怕网页偷跑流量.</p>
<h2 id="只有用户手动触发的事件能调用playload"><a class="markdownIt-Anchor" href="#只有用户手动触发的事件能调用playload"></a> 只有用户手动触发的事件能调用play/load</h2>
<p>既然autoplay不能用,那能不能用play方法来自动播放呢?<br />
很遗憾的是, 不行.<br />
例如下面这样,在移动端没效果:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;audio&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  audioEl.<span class="title function_">play</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>先来看看水果的文档:</p>
<blockquote>
<p>In Safari on iOS (for all devices, including iPad), where the user may be on a cellular network and be charged per data unit, preload and autoplay are disabled. No data is loaded until the user initiates it. This means the JavaScript play() and load() methods are also inactive until the user initiates playback, unless the play() or load() method is triggered by user action. In other words, a user-initiated Play button works, but an onLoad=&quot;play()&quot; event does not.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/AudioVideo/Conceptual/Using_HTML5_Audio_Video/Device-SpecificConsiderations/Device-SpecificConsiderations.html">iOS-Specific Considerations</a></p>
<p>也就是说,只有当用户手动触发某个事件时,audio.play才能被调用.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">click由用户触发, 有效</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Play&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;document.myMovie.play()&quot;</span>&gt;</span></span><br><span class="line">onload事件不是用户触发的,无效</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">&quot;document.myMovie.play()&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>因此,可以给外层元素绑定一个click事件.<br />
只要用户点了这个元素,就能播放音乐.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;audio&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> played = <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">()=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!played) &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">play</span>()</span></span><br><span class="line"><span class="language-javascript">      played = <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>对于safari浏览器需要注意,不要把播放事件绑定在document.body元素上.(document.documentElement没有这个问题).<br />
例如下面的代码, 将play()事件绑在了document.body.<br />
这样做android的chrome可以正常播放, 但safari没有任何效果.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;audio&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> bodyEl = <span class="variable language_">document</span>.<span class="property">body</span> <span class="comment">// 注意这里</span></span></span><br><span class="line"><span class="language-javascript">  bodyEl.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">()=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">play</span>()</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>奇怪的是,如果把播放事件绑定在document.documentElement元素上的话,倒是可以成功触发play事件.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;audio&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span> <span class="comment">// 注意这里</span></span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">()=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">play</span>()</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>另外要注意, html/body可能比屏幕小,这点很容易被人遗忘.<br />
<img src="/img/d2c875bc.png" alt="2.png" /><br />
<img src="/img/6f74c533.png" alt="1.png" /></p>
<h2 id="时间限制"><a class="markdownIt-Anchor" href="#时间限制"></a> 时间限制</h2>
<p>即使是用户触发的事件,也有时间限制.<br />
这个时间限制无论android的chrome还是safari,推测都是1000ms以上.<br />
例如下面在1001ms时调用play方法, 播放失败.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">  html &#123;</span><br><span class="line">    height: 100%;</span><br><span class="line">    border: 1px solid;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;audio controls src=&quot;./music/1.mp3&quot;&gt;&lt;/audio&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  const audioEl = document.querySelector(&quot;audio&quot;);</span><br><span class="line">  const documentEl = document.documentElement; // 注意这里</span><br><span class="line">  documentEl.addEventListener(&quot;click&quot;, () =&gt; &#123;</span><br><span class="line">    setTimeout(()=&gt; &#123; //注意这里</span><br><span class="line">      audioEl.play();</span><br><span class="line">    &#125;, 1001)</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>而把setTimeout的延迟时间改成1000,则能正常播放音乐.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(()=&gt; &#123; </span><br><span class="line">  audioEl.play();</span><br><span class="line">&#125;, 1000)</span><br></pre></td></tr></table></figure>
<h2 id="再次触发"><a class="markdownIt-Anchor" href="#再次触发"></a> 再次触发</h2>
<p>实际上对于同一段音频而言, 只有在首次播放时, 需要由用户手动触发,而再次触发则没有这个限制.<br />
下面是一个例子, 使用setTimeout在3秒时暂停播放, 在6s时恢复播放.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;audio&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span>; </span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">play</span>(); <span class="comment">// 首次播放</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">pause</span>(); <span class="comment">// 3秒后暂停</span></span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> audioEl.<span class="title function_">play</span>(), <span class="number">3000</span>); <span class="comment">// 6秒后再次恢复播放</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">3000</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/a4168006.gif" alt="1.gif" /></p>
<p>注意gif中的播放器,其在第3秒时停止, 又过了一段时间后,自动恢复播放.<br />
在此期间, 并没有手动触发任何事件,再次播放的行为完全是由js控制来完成的.</p>
<p>即便把setTimeout放在外面,仍然可以正常播放,例如下面的这段代码:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;audio&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span>; </span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">play</span>(); <span class="comment">// 首次播放</span></span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 把暂停放在外面,点击事件一点关系都没有  </span></span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">pause</span>(); <span class="comment">// 5秒后暂停</span></span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> audioEl.<span class="title function_">play</span>(), <span class="number">3000</span>); <span class="comment">// 6秒后再次播放</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">5000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么, 如果在播放途中更改了音频地址(audio.src),还能不能调用audio.play呢?<br />
下面代码在1秒后暂停播放音频, 然后再5秒后更换音频地址,播放新的音频.在safari和chrome(android)下都能正常工作</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;audio&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span>; </span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">play</span>(); <span class="comment">// 首次播放</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">pause</span>() <span class="comment">// 1秒后暂停</span></span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; <span class="comment">// 5秒后更改音频地址, 播放新的音频  </span></span></span><br><span class="line"><span class="language-javascript">        audioEl.<span class="property">src</span>=<span class="string">&quot;./music/2.mp3&quot;</span></span></span><br><span class="line"><span class="language-javascript">        audioEl.<span class="title function_">play</span>()</span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="number">5000</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">1000</span>);  </span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这似乎可以得出一个结论, 当网页加载后,只有第一次需要用户来触发audio.play,再这之后就不需要了.<br />
真的是这样吗?如果把audio元素删了,再新建一个audio,会怎么样?</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;audio&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span>; </span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">play</span>(); <span class="comment">// 首次播放</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="property">parentElement</span>.<span class="title function_">removeChild</span>(audioEl) <span class="comment">// 从Dom中删除audio元素</span></span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> newAduioEl = <span class="keyword">new</span> <span class="title class_">Audio</span>() <span class="comment">// 新建audio</span></span></span><br><span class="line"><span class="language-javascript">        newAduioEl.<span class="property">src</span> = <span class="string">&quot;./music/1.mp3&quot;</span></span></span><br><span class="line"><span class="language-javascript">        newAduioEl.<span class="property">controls</span> = <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(newAduioEl)</span></span><br><span class="line"><span class="language-javascript">        newAduioEl.<span class="title function_">play</span>() <span class="comment">// 企图再次播放, 但没有成功  </span></span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="number">3000</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">2000</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码中,我们在第2s时销毁了audio元素.然后在第5s新建了一个新的audio,然后将新audio添加到Dom, 同时调用aduio.play企图再次播放音频.<br />
遗憾的是, 无论是chrome(android).还是safari,都无法接着播放了.</p>
<p>但是, 如果不销毁audio元素,只是将其从Dom节点中移除, 过一会在添回去的话,会怎样呢?</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;audio&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span>; </span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">play</span>(); <span class="comment">// 首次播放</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">let</span> audio = audioEl.<span class="property">parentElement</span>.<span class="title function_">removeChild</span>(audioEl) <span class="comment">// 移除audio</span></span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(audio) <span class="comment">// 再添回去</span></span></span><br><span class="line"><span class="language-javascript">        audio.<span class="title function_">play</span>() <span class="comment">// 再次播放</span></span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="number">3000</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">2000</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这次没有销毁/新建audio,只是把audio从Dom中移除储存在变量中, 然后在第5s时又放回了Dom,播放成功.</p>
<p>真的有人会闲的没事删掉audio元素在重新添加一个吗?<br />
一般来讲,我们不会这么干,但有些框架就不一定了.<br />
特别是一些虚拟路由,会在切换的时候自动销毁/重建Dom结构, 如果不小新把audio放到了里面, 就有可能被删掉重建, 引发异常.<br />
但是虚拟路由的切换可能并不会刷新页面, 只是销毁/添加部分Dom结构.<br />
如果audio偶尔不能播放,加上框架加大了调试难度, 有时候很难往这方面想.</p>
<h2 id="src延迟加载"><a class="markdownIt-Anchor" href="#src延迟加载"></a> src延迟加载</h2>
<p>可能出于节省流量或是防抓取的目的,需要在用户点击播放按钮时, 才向服务器获取音频的地址.<br />
如果网络状态很差, 过了2秒才返回数据.要怎么作呢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">  html &#123;</span><br><span class="line">    height: 100%;</span><br><span class="line">    border: 1px solid;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;audio controls src=&quot;&quot;&gt;&lt;/audio&gt; //注意这里,初始src为空.</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  const audioEl = document.querySelector(&quot;audio&quot;);</span><br><span class="line">  const documentEl = document.documentElement; </span><br><span class="line">  documentEl.addEventListener(&quot;click&quot;, () =&gt; &#123;</span><br><span class="line">    setTimeout(() =&gt; &#123; // 用setTimeout模拟一个2秒的延迟</span><br><span class="line">      audioEl.src = &quot;./music/1.mp3&quot; //获取了src</span><br><span class="line">      audioEl.play(); // 企图再次播放</span><br><span class="line">    &#125;, 2000);</span><br><span class="line">    audioEl.play(); // 先触发一次播放事件,如果网络不好超过1s是肯定无法播放的.</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中, 先调用了一次audioEl.play, 然后在2s后才从服务器获取到audio.src地址.<br />
这么写在chrome(android)下可以运行, 但是safari不行.</p>
<p>兼容safari的办法很简单,只要在初始状态下,把audio.src指向一个无声音频就可以了.<br />
当用户第一次点击屏幕时, 依次调用audio.play和audio.pause.<br />
这样作既解决了第一次点击的问题,同时用户还不会有任何感觉.<br />
示例如下,兼容safari:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 注意这里,先加载了一个无声音频 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">controls</span> <span class="attr">src</span>=<span class="string">&quot;./music/1-second-of-silence.mp3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> audioEl = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;audio&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span>; </span></span><br><span class="line"><span class="language-javascript">  documentEl.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">play</span>(); <span class="comment">// 用户点击屏幕后播放空白音频</span></span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="title function_">pause</span>();  <span class="comment">// 然后立刻暂停  </span></span></span><br><span class="line"><span class="language-javascript">    audioEl.<span class="property">src</span>= <span class="string">&quot;&quot;</span> <span class="comment">// 移除src, 防止之后播放空白音频  </span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; <span class="comment">// 用setTimeout模拟一个2秒的延迟</span></span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="property">src</span> = <span class="string">&quot;./music/1.mp3&quot;</span></span></span><br><span class="line"><span class="language-javascript">      audioEl.<span class="title function_">play</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">2000</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="其他限制"><a class="markdownIt-Anchor" href="#其他限制"></a> 其他限制</h2>
<p>其他限制可能还有<br />
1 不能用volume设置音量,且永远返回1<br />
2 不能用playbackRate调节播放速度</p>
<h2 id="在vue中使用audio的示例"><a class="markdownIt-Anchor" href="#在vue中使用audio的示例"></a> 在Vue中使用audio的示例</h2>
<p>注意, vue 2.5.x版本的watch有bug.<br />
需升级到vue 2.6.x或降级为2.4.x .</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 解决移动端首次播放音频需要由用户手动触发的问题</span></span><br><span class="line">    <span class="comment">// 具体方法:</span></span><br><span class="line">    <span class="comment">// 在documentElement 绑定一个click事件</span></span><br><span class="line">    <span class="comment">// 当用户首次点击屏幕时, 播放空白音频</span></span><br><span class="line">    <span class="keyword">const</span> documentEl = <span class="variable language_">document</span>.<span class="property">documentElement</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">firstPlay</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">audio</span> = <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">audio</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">audio</span>.<span class="property">src</span> = <span class="string">&#x27;./1-second-of-silence.mp3&#x27;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">audio</span>.<span class="title function_">play</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">audio</span>.<span class="title function_">pause</span>()</span><br><span class="line">      <span class="comment">// 清除src,防止误将空白音频当成音乐地址,造成不断的调用next方法切换音乐</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">audio</span>.<span class="property">src</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="comment">// 移除事件, 因为只需要执行一次</span></span><br><span class="line">      documentEl.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>, firstPlay)</span><br><span class="line">    &#125;</span><br><span class="line">    documentEl.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, firstPlay)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">computed</span>: &#123;</span><br><span class="line">    <span class="title function_">music</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">getMusics</span>[<span class="variable language_">this</span>.<span class="property">getMusicIndex</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 我们用vuex跟踪歌曲信息, getMusics返回歌曲列表, getMusicIndex返回歌曲列表指针</span></span><br><span class="line">      ...<span class="title function_">mapGetters</span>([<span class="string">&#x27;getMusics&#x27;</span>, <span class="string">&#x27;getMusicIndex&#x27;</span>])</span><br><span class="line">  &#125;,</span><br><span class="line"> <span class="attr">watch</span>: &#123;</span><br><span class="line">    <span class="title function_">music</span>(<span class="params">newMusic</span>) &#123;</span><br><span class="line">      <span class="comment">// 为什么不直接watch歌曲指针(getMuscicIndex)?</span></span><br><span class="line">      <span class="comment">// 如果在播放某专辑中第一首歌曲时切换到另一个专辑, index不会变化(都是0)</span></span><br><span class="line">      <span class="comment">// 必须同时监控歌曲列表(getMusics)和歌曲指针(getMuscicIndex)这两者的变化  </span></span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">audioPlay</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">getPlayState</span>) &#123;</span><br><span class="line">          <span class="comment">// 一定要在真实的Dom: audio.src被修改后,再调用audio.play方法  </span></span><br><span class="line">          <span class="comment">// 尽管写入了数据,但Vue要等到下一个tick才会更新Dom</span></span><br><span class="line">          <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">audio</span>.<span class="title function_">play</span>()</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 有歌曲地址时,直接播放</span></span><br><span class="line">      <span class="keyword">if</span> (newMusic.<span class="property">src</span>) &#123;</span><br><span class="line">        <span class="title function_">audioPlay</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 没有歌曲地址时, 获取地址, 然后播放</span></span><br><span class="line">      <span class="title function_">getSongFile</span>(newMusic.<span class="property">mid</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> url = res.<span class="property">url</span></span><br><span class="line">        <span class="keyword">if</span> (!url) &#123;</span><br><span class="line">          <span class="comment">// 数据源没有这首歌时, 自动切换到下一首</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">next</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// vue无法自动跟踪直接赋值的新属性</span></span><br><span class="line">          <span class="comment">// music.src = res.url</span></span><br><span class="line">          <span class="comment">// 如果需要添加新属性, 请使用$set</span></span><br><span class="line">          <span class="variable language_">this</span>.$set(newMusic, <span class="string">&#x27;src&#x27;</span>, res.<span class="property">url</span>)</span><br><span class="line">          <span class="title function_">audioPlay</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/AudioVideo/Conceptual/Using_HTML5_Audio_Video/Device-SpecificConsiderations/Device-SpecificConsiderations.html">iOS-Specific Considerations</a><br />
<a target="_blank" rel="noopener" href="https://github.com/wangjx9110/document/blob/master/audio_summary.md">document/audio_summary.md at master · wangjx9110/document · GitHub</a><br />
<a target="_blank" rel="noopener" href="https://github.com/DDFE/DDFE-blog/issues/24">Vue.js 升级踩坑小记 · Issue #24 · DDFE/DDFE-blog · GitHub</a></p>

      </div>
    </article>
  </div>
  <!-- pagination -->
  
    <nav class="pagination">
      
        <a class="prev" href="/article/Js%E6%98%AF%E4%B8%80%E9%97%A8_%E5%8D%95%E7%BA%BF%E7%A8%8B_%E8%AF%AD%E8%A8%80/">&lt;  Js是一门&#34;单线程&#34;语言</a>
      
      
        <a class="next" href="/article/transform%E5%AF%BC%E8%87%B4fixed%E5%A4%B1%E6%95%88/">transform导致fixed失效  &gt;</a>
      
    </nav>    
  
  <!-- pagination end -->
</div>






    </main>

    <!-- search -->
     
    
    <script src="/js/main.js"></script>
     
  </body>
</html>
